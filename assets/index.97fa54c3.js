import{V as S,F as V}from"./validation.7606bf3f.js";import{I as L}from"./index.7e6c9d9a.js";import{P as D}from"./index.0c749892.js";import{I as T}from"./index.3336b4f6.js";import{R as B}from"./index.19abdf8c.js";import{d as F}from"./create.03b31fc7.js";import{i as I,o as w,d as R,q as M,t as x}from"./shared.f8da68a0.js";import{c as E}from"./relation.9e421618.js";import{n as z}from"./index.0a9349fd.js";const A={value:{type:Array,default:()=>[]},accept:{type:String,default:"image/*"},capture:{type:[String,Boolean],default:void 0},multiple:{type:Boolean,default:!1},readonly:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1},removable:{type:Boolean,default:!0},maxlength:{type:[Number,String]},maxsize:{type:[Number,String]},previewed:{type:Boolean,default:!0},ripple:{type:Boolean,default:!0},validateTrigger:{type:Array,default:()=>["onChange","onRemove"]},rules:{type:Array}};var N=function(){var e=this,a=e.$createElement,r=e._self._c||a;return r("div",{staticClass:"var-uploader var--box"},[r("div",{staticClass:"var-uploader__file-list"},[e._l(e.value,function(t){return r("div",{directives:[{name:"ripple",rawName:"v-ripple",value:{disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly||!e.ripple},expression:"{ disabled: disabled || formDisabled || readonly || formReadonly || !ripple }"}],key:t.id,staticClass:"var-uploader__file var-elevation--2",class:[t.state==="loading"?"var-uploader--loading":null],on:{click:function(s){return e.preview(t)}}},[r("div",{staticClass:"var-uploader__file-name"},[e._v(" "+e._s(t.name||t.url)+" ")]),e.removable?r("div",{staticClass:"var-uploader__file-close",on:{click:function(s){return s.stopPropagation(),e.handleRemove(t)}}},[r("var-icon",{staticClass:"var-uploader__file-close-icon",attrs:{"var-uploader-cover":"",name:"delete"}})],1):e._e(),t.cover?r("img",{staticClass:"var-uploader__file-cover",style:{objectFit:t.fit},attrs:{src:t.cover,alt:t.name}}):e._e(),r("div",{staticClass:"var-uploader__file-indicator",class:[t.state==="success"?"var-uploader--success":null,t.state==="error"?"var-uploader--error":null]})])}),!e.maxlength||e.value.length<e.maxlength?r("div",{directives:[{name:"ripple",rawName:"v-ripple",value:{disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly||!e.ripple||e.hasSlots("default")},expression:"{ disabled: disabled || formDisabled || readonly || formReadonly || !ripple || hasSlots('default') }"}],staticClass:"var--relative",class:[e.hasSlots("default")?null:"var-uploader__action var-elevation--2",e.disabled||e.formDisabled?"var-uploader--disabled":null]},[r("input",{staticClass:"var-uploader__action-input",attrs:{type:"file",multiple:e.multiple,accept:e.accept,capture:e.capture,disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly},on:{change:e.handleChange}}),e._t("default",function(){return[r("var-icon",{staticClass:"var-uploader__action-icon",attrs:{"var-uploader-cover":"",name:"plus"}})]})],2):e._e()],2),r("var-form-details",{attrs:{"error-message":e.errorMessage,"maxlength-text":e.maxlengthText}}),r("var-popup",{attrs:{class:"var-uploader__preview","var-uploader-cover":"",position:"center",show:e.showPreview},on:{"update:show":function(t){e.showPreview=t},closed:function(t){e.currentPreview=null}}},[e.currentPreview&&e.isHTMLSupportVideo(e.currentPreview.url)?r("video",{staticClass:"var-uploader__preview-video",attrs:{playsinline:"true","webkit-playsinline":"true","x5-playsinline":"true","x5-video-player-type":"h5","x5-video-player-fullscreen":"false",controls:"",src:e.currentPreview&&e.currentPreview.url}}):e._e()])],1)},$=[];let k=0;const U=F({name:"VarUploader",mixins:[S,E("form",{parentKey:"form",childrenKey:"formItems"})],directives:{Ripple:B},components:{VarIcon:L,VarPopup:D,VarFormDetails:V},props:A,data:()=>({showPreview:!1,currentPreview:null,callReset:!1}),computed:{maxlengthText(){const{maxlength:e,value:{length:a}}=this;return I(e)?`${a} / ${e}`:""},formDisabled(){var e;return(e=this.form)==null?void 0:e.disabled},formReadonly(){var e;return(e=this.form)==null?void 0:e.readonly}},watch:{value:{handler(){!this.callReset&&this.validateWithTrigger("onChange"),this.callReset=!1},deep:!0}},methods:{getSuccess(){return this.value.filter(e=>e.state==="success")},getError(){return this.value.filter(e=>e.state==="error")},getLoading(){return this.value.filter(e=>e.state==="loading")},validate(){this._validate(this.rules,this.value,{getSuccess:this.getSuccess,getError:this.getError,getLoading:this.getLoading})},reset(){var e,a;this.callReset=!0,(a=(e=this.getListeners()).onInput)==null||a.call(e,[]),this.resetValidation()},isHTMLSupportVideo:w,validateWithTrigger(e){this.$nextTick(()=>{const{validateTrigger:a,rules:r,value:t}=this;this._validateWithTrigger(a,e,r,t,{getSuccess:this.getSuccess,getError:this.getError,getLoading:this.getLoading})})},preview(e){const{disabled:a,readonly:r,previewed:t}=this;if(this.formDisabled||this.formReadonly||a||r||!t)return;const{url:s}=e;if(R(s)&&M(s)){T(s);return}R(s)&&w(s)&&(this.currentPreview=e,this.showPreview=!0)},createVarFile(e){return{id:k++,url:"",cover:"",name:e.name,file:e}},getFiles(e){const a=e.target,{files:r}=a;return Array.from(r)},resolver(e){return new Promise(a=>{const r=new FileReader;r.onload=()=>{const t=r.result;e.file.type.startsWith("image")&&(e.cover=t),e.url=t,a(e)},r.readAsDataURL(e.file)})},getResolvers(e){return e.map(this.resolver)},getBeforeReaders(e){const{onBeforeRead:a}=this.getListeners();return e.map(r=>new Promise(t=>{const s=a?a(r):!0;Promise.resolve(s).then(d=>t({valid:d,varFile:r}))}))},async handleChange(e){var _,y;const{formDisabled:a,formReadonly:r,maxsize:t,maxlength:s,value:d,readonly:v,disabled:p,getListeners:i}=this;if(a||r||p||v)return;const u=l=>l.filter(n=>{var c,b;return n.file.size>x(t)?((b=(c=i()).onOversize)==null||b.call(c,n),!1):!0}),m=l=>{const n=Math.min(l.length,x(s)-d.length);return l.slice(0,n)};let o=this.getFiles(e).map(this.createVarFile);o=t!=null?u(o):o,o=s!=null?m(o):o;const C=await Promise.all(this.getResolvers(o)),g=(await Promise.all(this.getBeforeReaders(C))).filter(({valid:l})=>l).map(({varFile:l})=>l);(y=(_=i()).onInput)==null||y.call(_,[...d,...g]),e.target.value="",g.forEach(l=>{var n,c;return(c=(n=i()).onAfterRead)==null?void 0:c.call(n,l)})},async handleRemove(e){const{formDisabled:a,formReadonly:r,disabled:t,readonly:s,value:d,getListeners:v}=this,{onBeforeRemove:p,onRemove:i,onInput:u}=v();if(a||r||t||s||p&&!await p(e))return;const m=d.filter(h=>h!==e);i==null||i(e),this.validateWithTrigger("onRemove"),u==null||u(m)}}}),P={};var W=z(U,N,$,!1,H,null,null,null);function H(e){for(let a in P)this[a]=P[a]}var f=function(){return W.exports}();f.install=function(e){e.component(f.name,f)};export{f as U};
